<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trò chuyện với khách hàng</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="{{ url_for('static', filename='script.js') }}"></script>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
</head>

<body>
    <header>
        <div class="container">
            <h1>ỨNG DỤNG QUẢN LÝ CHAT</h1>
        </div>
    </header>
    <main>
        <div class="container">
            <div class="row">
                <div class="col-md-3">
                    <div class="sidebar">
                        <ul>
                            <li><a href="/user">Danh sách người dùng</a></li>
                            <li><a href="/faq">Quản lý câu hỏi - Trả lời</a></li>
                            <li><a href="/chatbot-response">Quản lý Chatbox Response</a></li>
                            <li><a href="">Lịch sử chat</a></li>
                        </ul>
    
                        <div id="customer-list-container">
                            <div class="title">Danh sách khách hàng online <span class="minux">_</span></div>
                            <ul id="customer-list">    
                            </ul>
                        </div>
                        
                        <div id="chat-windows">
                         
                        </div>
                    </div>
                </div>
                <div class="col-md-9">
                    {% block content %}{% endblock %}
                </div>
            </div>
        </div>
    </main>
    
    <script>
        const staffId = 42;
        const socket = io({query: { user_id: staffId } });
        // Cập nhật danh sách cuộc hội thoại có staffId tham gia
        socket.on('update_conversations_staff', function(data){
            const convers = document.getElementById('chat-windows');
            convers.innerHTML = '';
            convers.forEach(function(conver){
                const converItem = document.createElement('div');
                converItem.id = 'chat-window-' + conver.id;
                converItem.className = 'chat-window';
                chatWindow.innerHTML = `
                    <div class="title"><span>Chat với khách hàng ${converItem.user_id}</span><span class="minus"></span></div>
                    <div class="chat-box" id="chat-box-${converItem.user_id}"></div>
                    <div class="input-container">
                        <input type="text" id="message-input-${converItem.user_id}" placeholder="Type a message...">
                        <button onclick="sendMessage(${converItem.user_id})">Send</button>
                    </div>
                `;
                convers.appendChild();
            })
        })
         // Cập nhật danh sách khách hàng
        socket.on('update_user_list', function(user_data) {
            const userList = document.getElementById('customer-list');
            userList.innerHTML = '';  // Xóa danh sách cũ
            user_data.forEach(function(user, index) {
                const userItem = document.createElement('li');
                userItem.id = 'user-' + user.id;
                userItem.className = 'conversation-' + user.conversation_id;
                userItem.innerHTML = (index + 1) + '. ' + user.username + ' - ' + user.email;
                userItem.addEventListener('click', function() {
                    // Thêm hội thoại
                    if (!user.conversation_id) {
                            addToChat(user.id, staffId);
                        } else {
                            console.log('Hội thoại đã tồn tại.');
                        }
                    openWindow(user.id, user.conversation_id)
                });
                userList.appendChild(userItem);
            });
        });
    
        function addToChat(user_id, staff_id){
            debugger;
            socket.emit('new_conversation', {
                user_id: user_id,
                staff_id: staff_id
            });
        }
       
        // Lắng nghe tin nhắn từ khách và hiển thị trong cửa sổ chat tương ứng
        socket.on('new_message', function(data) {
            console.log('Received new_message:', data);
            
            messageElement = document.createElement('div');
            messageElement.className = "message " + data.message_type;
            messageElement.innerHTML = "<b>" + data.message_type + ":</b> " + data.message;
            const chatBox = document.getElementById('chat-box-' + data.conversation_id);
            chatBox.appendChild(messageElement);
    
            // Tự động cuộn xuống cuối
            chatBox.scrollTop = chatBox.scrollHeight;
    
        });
    
        socket.on('connect', function () {
            console.log("Đã kết nối với server qua Socket.io");
        });
        socket.on('disconnect', function () {
            console.log("Mất kết nối với server");
        });
    
        function loadMessages(conversation_id) {
                fetch(`/api/messages?conversation_id=${conversation_id}`)
                    .then(response => response.json())
                    .then(messages => {
                        const chatBox = document.getElementById(`chat-box-${conversation_id}`);
                        chatBox.innerHTML = messages
                            .map(message => `<div class="message ${message.message_type}"><b>${message.message_type}:</b> ${message.content}</div>`)
                            .join('');
                    })
                    .catch(error => {
                        console.error('Error loading messages:', error);
                    });
            }
        // Gửi tin nhắn từ nhân viên
        function sendMessage(userId, conversation_id) {
            debugger;
            const message = document.getElementById('message-input-' + userId).value;
            if (message) {
                socket.emit('new_message', {
                    message: message,
                    conversation_id: conversation_id,
                    sender_id: userId,
                    message_type: 'staff'
                });
                document.getElementById('message-input-' + userId).value = '';  // Xóa input sau khi gửi
            }
        }
    
        function openWindow(user_id, conversation_id){
            const converList = document.getElementById('chat-windows');
            const converItem = `<div class="chat-window"><div class="title">
                                    <span>Chat với khách hàng ${user_id}</span>
                                    <div class="action">
                                        <span class="minus" onclick="toggleChatWindow(${user_id})"></span>
                                        <span class="close" onclick="closeChatWindow()">X</span>
                                    </div>
                                </div>
                                <div class="chat-box" id="chat-box-${conversation_id}"></div>
                                <div class="input-container">
                                    <input type="text" id="message-input-${user_id}" placeholder="Type a message...">
                                    <button onclick="sendMessage(${user_id}, ${conversation_id})">Send</button>
                                </div></div>`;
           converList.innerHTML = converItem
           loadMessages(conversation_id);
        }
        window.onload = function() {
            socket.emit('get_users');
        };
    </script>
</body>
</html>