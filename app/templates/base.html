<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tr√≤ chuy·ªán v·ªõi kh√°ch h√†ng</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='summernote/summernote-bs4.min.css') }}" rel="stylesheet" />
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='admin.css') }}">
    <script src="{{ url_for('static', filename='script.js') }}"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script> -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        const staffId = 42;
        //window.socket = io({ query: { user_id: staffId } });
        window.socket = io({
            query: { user_id: staffId },
            transports: ["websocket"],   // Kh√¥ng cho ph√©p polling
            upgrade: false               // Kh√¥ng n√¢ng c·∫•p t·ª´ polling -> ws
        });

        window.socket.on('connect', () => console.log('‚úÖ Socket connected (base)'));
    </script>
</head>

<body>
    <header>
        <div class="container d-flex justify-content-between align-items-center">
            <h1 class="header-title">·ª®NG D·ª§NG QU·∫¢N L√ù CHAT</h1>
            <div id="notification-container" style="
                position: fixed;
                top: 10px;
                left: 50%;
                transform: translateX(-50%);
                z-index: 9999;
                width: auto;
            "></div>

            <a href="/logout" class="btn btn-outline-light logout-btn">ƒêƒÉng xu·∫•t</a>
        </div>
    </header>

    <main class="mt-3">
        <div class="container-fluid">
            <div class="row">
                <!-- Sidebar -->
                <div class="col-md-3">
                    {% include '_sidebar.html' %}
                </div>

                <!-- Main content -->
                <div class="col-md-9">
                    {% block content %}{% endblock %}

                    <!-- Danh s√°ch c·ª≠a s·ªï chat ƒë·ªông -->
                    <div id="chat-windows" class="mt-3"></div>
                </div>
            </div>
        </div>
    </main>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='summernote/summernote-bs4.min.js') }}"></script>
    <!-- Scripts -->
    <script>
        $(document).ready(function () {
            $('#content').summernote({
                height: 150, // chi·ªÅu cao khung so·∫°n th·∫£o
                placeholder: 'Nh·∫≠p n·ªôi dung phim ·ªü ƒë√¢y...'
            });
        });
    </script>
    <script>
        function confirmDeleteConversation(conversationId) {
            if (!conversationId) return;
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a to√†n b·ªô ƒëo·∫°n chat n√†y?')) {
                deleteConversation(conversationId);
            }
        }
        function deleteConversation(conversationId) {
            // N·∫øu d√πng CSRF token (Flask-WTF), ƒë·∫∑t token ·ªü meta tag v√† g·ª≠i header X-CSRFToken
            const csrfTokenMeta = document.querySelector('meta[name="csrf-token"]');
            const headers = {
                'Accept': 'application/json'
            };
            if (csrfTokenMeta) {
                headers['X-CSRFToken'] = csrfTokenMeta.getAttribute('content');
            }
            fetch(`/api/conversation/${conversationId}`, {
                method: 'DELETE',
                headers: headers,
                credentials: 'same-origin'
            })
                .then(async res => {
                    if (res.ok) {
                        const li = document.querySelector(`li[data-convo-id="${conversationId}"]`);
                        if (li) {
                            li.classList.add('fade-out');
                            setTimeout(() => li.remove(), 250);
                        }
                        const currentPath = window.location.pathname;
                        if (currentPath.includes(`/chat/${conversationId}`)) {
                            window.location.href = '/dashboard';
                        }
                        // t√πy ch·ªçn: y√™u c·∫ßu server g·ª≠i l·∫°i danh s√°ch online
                        // if (window.socket && window.socket.emit) {
                        //     window.socket.emit('get_users');
                        // }
                    } else {
                        let msg = 'X√≥a th·∫•t b·∫°i.';
                        try {
                            const data = await res.json();
                            if (data && data.error) msg = data.error;
                        } catch (e) { }
                        alert(msg);
                    }
                })
                .catch(err => {
                    console.error('L·ªói khi x√≥a conversation:', err);
                    alert('L·ªói k·∫øt n·ªëi khi x√≥a conversation.');
                });
        }

        window.socket.on('new_message', function (data) {
            const li = document.querySelector(`li[data-convo-id="${data.conversation_id}"]`);
            if (!li) return; // N·∫øu kh√¥ng t√¨m th·∫•y, tho√°t
            const strong = li.querySelector('strong');
            if (strong) {
                strong.textContent = "üë§ H·ªôi tho·∫°i: " + data.conversation_id;
            }
            const span = li.querySelector('span');
            if (span) {
                span.textContent = data.sender + " : " + data.message;
            }
            // C·∫≠p nh·∫≠t th·ªùi gian g·ª≠i trong <small>
            const small = li.querySelector('small');
            if (small) {
                const now = new Date().toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
                small.textContent = `${now} | Tr·∫°ng th√°i: ƒêang ho·∫°t ƒë·ªông`;
            }
            // Th√™m hi·ªáu ·ª©ng highlight ng·∫Øn ƒë·ªÉ b√°o tin nh·∫Øn m·ªõi
            li.classList.add('bg-warning-subtle');
            setTimeout(() => li.classList.remove('bg-warning-subtle'), 2000);

        });

        window.socket.on('new_tracking_event', function (data) {
                const container = document.getElementById('notification-container');
                if (!container) return;

                // T·∫°o th√¥ng b√°o
                const notif = document.createElement('div');
                notif.textContent = "üìå C√≥ truy c·∫≠p m·ªõi!";
                notif.style.background = "#0d6efd";
                notif.style.color = "#fff";
                notif.style.padding = "10px 20px";
                notif.style.marginTop = "5px";
                notif.style.borderRadius = "5px";
                notif.style.boxShadow = "0 2px 6px rgba(0,0,0,0.2)";
                notif.style.opacity = "0";
                notif.style.transition = "opacity 0.3s ease";

                container.appendChild(notif);

                // Hi·ªÉn th·ªã th√¥ng b√°o
                setTimeout(() => {
                    notif.style.opacity = "1";
                }, 10);

                // ·∫®n sau 3 gi√¢y
                setTimeout(() => {
                    notif.style.opacity = "0";
                    setTimeout(() => notif.remove(), 300);
                }, 3000);
            });

        function addToChat(user_id, staff_id) {
            socket.emit('new_conversation', {
                user_id,
                staff_id
            });
        }

        window.onload = function () {
            socket.emit('get_users');
        };


    </script>
</body>

</html>