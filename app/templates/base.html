<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trò chuyện với khách hàng</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='summernote/summernote-bs4.min.css') }}" rel="stylesheet" />
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='admin.css') }}">
    <script src="{{ url_for('static', filename='script.js') }}"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <!-- <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script> -->
    <script>
        const staffId = 42;
        window.socket = io({ query: { user_id: staffId } });
        window.socket.on('connect', () => console.log('✅ Socket connected (base)'));
    </script>
</head>
<body>
    <header>
        <div class="container d-flex justify-content-between align-items-center">
            <h1 class="header-title">ỨNG DỤNG QUẢN LÝ CHAT</h1>
            <a href="/logout" class="btn btn-outline-light logout-btn">Đăng xuất</a>
        </div>
    </header>

    <main class="mt-3">
        <div class="container-fluid">
            <div class="row">
                <!-- Sidebar -->
                <div class="col-md-3">
                    {% include '_sidebar.html' %}
                </div>

                <!-- Main content -->
                <div class="col-md-9">
                    {% block content %}{% endblock %}

                    <!-- Danh sách cửa sổ chat động -->
                    <div id="chat-windows" class="mt-3"></div>
                </div>
            </div>
        </div>
    </main>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='summernote/summernote-bs4.min.js') }}"></script>
    <!-- Scripts -->
    <script>
        $(document).ready(function () {
            $('#content').summernote({
                height: 150, // chiều cao khung soạn thảo
                placeholder: 'Nhập nội dung phim ở đây...'
            });
        });
    </script>
    <script>
        function confirmDeleteConversation(conversationId) {
            if (!conversationId) return;
            if (confirm('Bạn có chắc muốn xóa toàn bộ đoạn chat này?')) {
                deleteConversation(conversationId);
            }
        }
        function deleteConversation(conversationId) {
            // Nếu dùng CSRF token (Flask-WTF), đặt token ở meta tag và gửi header X-CSRFToken
            const csrfTokenMeta = document.querySelector('meta[name="csrf-token"]');
            const headers = {
                'Accept': 'application/json'
            };
            if (csrfTokenMeta) {
                headers['X-CSRFToken'] = csrfTokenMeta.getAttribute('content');
            }
            fetch(`/api/conversation/${conversationId}`, {
                method: 'DELETE',
                headers: headers,
                credentials: 'same-origin' 
            })
                .then(async res => {
                    if (res.ok) {
                        const li = document.querySelector(`li[data-convo-id="${conversationId}"]`);
                        if (li) {
                            li.classList.add('fade-out');
                            setTimeout(() => li.remove(), 250);
                        }
                        const currentPath = window.location.pathname;
                        if (currentPath.includes(`/chat/${conversationId}`)) {
                            window.location.href = '/dashboard';
                        }
                        // tùy chọn: yêu cầu server gửi lại danh sách online
                        // if (window.socket && window.socket.emit) {
                        //     window.socket.emit('get_users');
                        // }
                    } else {
                        let msg = 'Xóa thất bại.';
                        try {
                            const data = await res.json();
                            if (data && data.error) msg = data.error;
                        } catch (e) { }
                        alert(msg);
                    }
                })
                .catch(err => {
                    console.error('Lỗi khi xóa conversation:', err);
                    alert('Lỗi kết nối khi xóa conversation.');
                });
        }
    
        window.socket.on('new_message', function (data) {
            const li = document.querySelector(`li[data-convo-id="${data.conversation_id}"]`);
            if (!li) return; // Nếu không tìm thấy, thoát
            const strong = li.querySelector('strong');
            if (strong) {
                strong.textContent = data.sender + ": " + data.message;
            }
            // Cập nhật thời gian gửi trong <small>
            const small = li.querySelector('small');
            if (small) {
                const now = new Date().toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
                small.textContent = `${now} | Trạng thái: Đang hoạt động`;
            }
            // Thêm hiệu ứng highlight ngắn để báo tin nhắn mới
            li.classList.add('bg-warning-subtle');
            setTimeout(() => li.classList.remove('bg-warning-subtle'), 2000);

        });

        function addToChat(user_id, staff_id) {
            socket.emit('new_conversation', {
                user_id,
                staff_id
            });
        }
        
        window.onload = function () {
            socket.emit('get_users');
        };

        // window.socket.on('update_user_list', function (user_data) {
        //     const userList = document.getElementById('customer-list');
        //     userList.innerHTML = '';
        //     user_data.forEach(function (user, index) {
        //         const userItem = document.createElement('li');
        //         userItem.className = 'list-group-item';
        //         userItem.innerHTML = `${index + 1}. ${user.username} - ${user.email}`;
        //         userItem.addEventListener('click', function () {
        //             if (!user.conversation_id) {
        //                 addToChat(user.id, staffId);
        //             } else {
        //                 console.log('Hội thoại đã tồn tại.');
        //                 openWindow(user.id, user.conversation_id);
        //             }
        //         });
        //         userList.appendChild(userItem);
        //     });
        // });

        // function sendMessage(userId, conversation_id) {
        //     const messageInput = document.getElementById('message-input-' + userId);
        //     const message = messageInput.value.trim();
        //     if (message) {
        //         socket.emit('new_message', {
        //             message,
        //             conversation_id,
        //             sender_id: userId,
        //             message_type: 'staff'
        //         });
        //         messageInput.value = '';
        //     }
        // }

        // function openWindow(user_id, conversation_id) {
        //     const converList = document.getElementById('chat-windows');
        //     const converItem = `
        //         <div class="chat-window">
        //             <div class="title d-flex justify-content-between align-items-center">
        //                 <span>Chat với khách hàng ${user_id}</span>
        //                 <div>
        //                     <button class="btn btn-sm btn-outline-secondary me-2" onclick="toggleChatWindow(${user_id})">_</button>
        //                     <button class="btn btn-sm btn-outline-danger" onclick="closeChatWindow()">X</button>
        //                 </div>
        //             </div>
        //             <div class="chat-box" id="chat-box-${conversation_id}"></div>
        //             <div class="input-container">
        //                 <input type="text" id="message-input-${user_id}" class="form-control" placeholder="Nhập tin nhắn...">
        //                 <button class="btn btn-primary" onclick="sendMessage(${user_id}, ${conversation_id})">Gửi</button>
        //             </div>
        //         </div>`;
        //     converList.innerHTML = converItem;
        //     loadMessages(conversation_id);
        // }

        // function loadMessages(conversation_id) {
        //     fetch(`/api/messages?conversation_id=${conversation_id}`)
        //         .then(response => response.json())
        //         .then(messages => {
        //             const chatBox = document.getElementById(`chat-box-${conversation_id}`);
        //             chatBox.innerHTML = messages
        //                 .map(msg => `<div class="message ${msg.message_type}"><b>${msg.message_type}:</b> ${msg.content}</div>`)
        //                 .join('');
        //         })
        //         .catch(err => console.error('Lỗi tải tin nhắn:', err));
        // }
    </script>
</body>
</html>