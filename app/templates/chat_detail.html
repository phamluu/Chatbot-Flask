{% extends "base.html" %}
{% block content %}
<style>
:root{
    --chat-form-height: 72px;   /* chiều cao khung chat */
    --admin-bar-height: 56px;   /* chiều cao thanh trạng thái */
    --page-gap: 20px;           /* khoảng cách tổng thể */
}

html,body{ height:100%; }
body{ margin:0; padding:0; font-family:system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:#f5f6f8; }

/* Khu vực tin nhắn - mặc định (chat ẩn): chỉ chừa chỗ cho admin bar */
#result {
    width: 90%;
    max-width: 980px;
    margin: var(--page-gap) auto;
    padding: 1em;
    background: #fff;
    border-radius: 10px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    /* khi chat đóng thì chỉ chừa chỗ cho admin bar (không chừa chỗ cho chat form) */
    height: calc(100vh - (var(--admin-bar-height) + var(--page-gap) + 20px));
    min-height: 120px;
    overflow-y: auto;
}

/* Khi chat mở, result sẽ co lại để nhường chỗ cho chat form + admin bar */
body.chat-open #result{
    height: calc(100vh - (var(--admin-bar-height) + var(--chat-form-height) + var(--page-gap) + 20px));
}

.form-group{ margin: 1rem 0; }
.form-group small{ text-align:right; display:block; }
.form-group.admin-message, .form-group.bot-message { text-align: right; }
.user-message .inner { background: #33333314; display:inline-block; padding:0.5rem; border-radius:11px; }

/* Khung chat (fixed bottom) - ẩn mặc định. Khi body.chat-open => hiển thị. */
.chat-form{
    position: fixed;
    left: 0;
    bottom: 0;
    width: 100%;
    height: var(--chat-form-height);
    display: none; /* hiển thị khi body có class chat-open */
    align-items: center;
    z-index: 999;
    background-color: rgba(255,255,255,0.98);
    border-top: 1px solid #e6e6e6;
    box-shadow: 0 -2px 8px rgba(0,0,0,0.04);
}

body.chat-open .chat-form{ display:flex; }

#chat-form-container{ width: 700px; max-width: 100%; margin: 0 auto; padding: 10px 15px; display:flex; align-items:center; }
#chat-form{ display:flex; width:100%; align-items:center; }
input[type="text"]{ flex:1; border:none; padding:12px 16px; font-size:16px; border-radius:30px; outline:none; background:#f8f9fa; }
button{ border:none; background:#007bff; color:#fff; padding:12px 18px; margin-left:10px; font-size:16px; border-radius:30px; cursor:pointer; }
button:hover{ background:#0056b3; }

/* Thanh trạng thái admin - đặt phía trên, "ngoài" khung chat (không nằm trong vùng scroll result) */
.admin-status-bar{
    height: var(--admin-bar-height);
    z-index: 1000;
    display:flex;
    align-items:center;
    justify-content:space-between;
    width: min(920px, 95%);
    padding: 8px 16px;
    background: #ffffff;
    border-radius: 12px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.08);
    border: 1px solid #e9ecef;
}

/* Nếu chat đang đóng, muốn thanh admin vẫn nằm trên cùng khu vực phía dưới (vẫn ngoài vùng scroll) */
body:not(.chat-open) .admin-status-bar{
    bottom: 16px; /* cách đáy màn hình 16px khi chat ẩn */
}

.status-indicator{ font-weight:700; color:#dc3545; }
.status-indicator.active{ color:#28a745; }
.btn-toggle{ border:none; padding:8px 12px; border-radius:8px; cursor:pointer; color:#fff; font-weight:700; }
.btn-start{ background:#28a745; }
.btn-start:hover{ background:#218838; }
.btn-stop{ background:#dc3545; }
.btn-stop:hover{ background:#c82333; }

/* Responsive */
@media (max-width:720px){
    :root{ --chat-form-height: 64px; --admin-bar-height: 52px; }
    #chat-form-container{ padding:8px; }
    input[type="text"]{ font-size:14px; padding:10px 12px; }
    .admin-status-bar{ width: calc(100% - 32px); bottom: calc(var(--chat-form-height) + 8px); }
}
</style>
<!-- Thanh trạng thái admin: đặt phía trên, ngoài khung chat, luôn cố định và không cần scroll để nhìn thấy -->
<div class="admin-status-bar" role="status" aria-live="polite">
    <div>Trạng thái: <span id="admin-status" class="status-indicator">🔴 Ngoại tuyến</span></div>
    <div>
        <button id="btn-start" class="btn-toggle btn-start">Bắt đầu tham gia</button>
        <button id="btn-stop" class="btn-toggle btn-stop" style="display:none;">Kết thúc</button>
    </div>
</div>
<!-- Danh sách tin nhắn -->
<div id="result">
    {% for msg in messages %}
        <div class="form-group {{ msg.message_type }}-message">
            <div class="inner">
                <b>{{ msg.message_type }}:</b> {{ msg.content }} <br>
                <small>{{ msg.sent_at }}</small>
            </div>
        </div>
    {% endfor %}
</div>

<!-- Khung chat (ẩn mặc định) -->
<div class="chat-form" id="chat-form-wrapper" aria-hidden="{{ 'false' if admin_active else 'true' }}">
    <div id="chat-form-container">
        <form id="chat-form">
            <input type="text" id="message" name="message" placeholder="Ví dụ: Tôi muốn đặt thiệp cưới..." required autocomplete="off" />
            <button type="submit">Gửi</button>
        </form>
    </div>
</div>



<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
const conversationId = "{{ conversation.id }}";
const form = document.getElementById('chat-form');
const resultDiv = document.getElementById('result');
const messageInput = document.getElementById('message');
const statusEl = document.getElementById('admin-status');
const btnStart = document.getElementById('btn-start');
const btnStop = document.getElementById('btn-stop');
const chatWrapper = document.getElementById('chat-form-wrapper');
let adminActive = false;

// helper: show / hide chat and update body class so CSS height calc thay đổi
function showChat(){
    document.body.classList.add('chat-open');
    chatWrapper.setAttribute('aria-hidden','false');
    // focus input (sau một chút để reflow)
    setTimeout(()=>{ try{ messageInput.focus(); } catch(e){} }, 50);
}
function hideChat(){
    document.body.classList.remove('chat-open');
    chatWrapper.setAttribute('aria-hidden','true');
    try{ messageInput.blur(); } catch(e){}
}

// Khi bấm Bắt đầu tham gia
btnStart.addEventListener('click', async () => {
    adminActive = true;
    showChat();
    statusEl.textContent = "🟢 Đang tham gia";
    statusEl.classList.add('active');
    btnStart.style.display = 'none';
    btnStop.style.display = 'inline-block';

    const message = "active";
    try{
        const res = await fetch(`/chat/bot/${conversationId}`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message })
        });
        await res.json();
    }catch(err){ console.error('❌ Lỗi fetch:', err); }
});

// Khi bấm Kết thúc
btnStop.addEventListener('click', async () => {
    adminActive = false;
    hideChat();
    statusEl.textContent = "🔴 Ngoại tuyến";
    statusEl.classList.remove('active');
    btnStart.style.display = 'inline-block';
    btnStop.style.display = 'none';

    const message = "inactive";
    try{
        const res = await fetch(`/chat/bot/${conversationId}`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message })
        });
        await res.json();
    }catch(err){ console.error('❌ Lỗi fetch:', err); }
});

// Gửi tin nhắn
form.addEventListener('submit', async (e) =>{
    e.preventDefault();
    if (!adminActive) return;
    const message = messageInput.value.trim();
    if(!message) return;

    resultDiv.insertAdjacentHTML('beforeend', `\n        <div class="form-group admin-message"><div class="inner"><strong>🧑 Admin:</strong> ${message}</div></div>\n    `);
    resultDiv.scrollTop = resultDiv.scrollHeight;
    messageInput.value = '';

    try{
        const res = await fetch(`/chat/${conversationId}`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message })
        });
        await res.json();
    }catch(err){ console.error('❌ Lỗi fetch:', err); }
});

// SocketIO - lắng nghe tin nhắn mới
// const socket = io();
// socket.on('connect', ()=> console.log('✅ Admin connected to SocketIO'));
const socket = window.socket;
socket.on('new_message', (data) =>{
    if (data.conversation_id != "{{ conversation.id }}") return;
    if (data.sender != 'admin'){
        resultDiv.insertAdjacentHTML('beforeend', `\n <div class="form-group ${data.sender}-message">\n <div class="inner"><strong>🧑 ${data.sender}:</strong> ${data.message}</div>\n            </div>\n        `);
        resultDiv.scrollTop = resultDiv.scrollHeight;
    }
    
});

// scroll to bottom on load
window.addEventListener('load', ()=>{ 
    const admin_active = "{{ admin_active }}";
    if (admin_active === "True" || admin_active === "true"){
        $("#btn-start").hide();
        $("#btn-stop").show();
        showChat();
    } else {
        $("#btn-stop").hide();
        $("#btn-start").show();
        hideChat();
    }
    resultDiv.scrollTop = resultDiv.scrollHeight; 
    });
</script>

{% endblock %}
