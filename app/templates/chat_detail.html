{% extends "base.html" %}
{% block content %}

<!-- Thanh trạng thái admin: đặt phía trên, ngoài khung chat, luôn cố định và không cần scroll để nhìn thấy -->
<div class="admin-status-bar" role="status" aria-live="polite">
    <div>Hội thoại: <strong>{{ conversation.id }}</strong></div>
    <div>Trạng thái: <span id="admin-status" class="status-indicator">🔴 Ngoại tuyến</span></div>
    <div>
        <button id="btn-start" class="btn-toggle btn-start">Bắt đầu tham gia</button>
        <button id="btn-stop" class="btn-toggle btn-stop" style="display:none;">Kết thúc</button>
    </div>
</div>
<!-- Danh sách tin nhắn -->
<div id="result">
    {% for msg in messages %}
        <div class="form-group {{ msg.message_type }}-message">
            <div class="inner">
                <b>{{ msg.message_type }}:</b> {{ msg.content }} <br>
                <small>{{ msg.sent_at }}</small>
            </div>
        </div>
    {% endfor %}
</div>

<!-- Khung chat (ẩn mặc định) -->
<div class="chat-form" id="chat-form-wrapper" aria-hidden="{{ 'false' if admin_active else 'true' }}">
    <div id="chat-form-container">
        <form id="chat-form">
            <input type="text" id="message" name="message" placeholder="Ví dụ: Tôi muốn đặt thiệp cưới..." required autocomplete="off" />
            <button type="submit">Gửi</button>
        </form>
    </div>
</div>

<script>
const conversationId = "{{ conversation.id }}";
const form = document.getElementById('chat-form');
const resultDiv = document.getElementById('result');
const messageInput = document.getElementById('message');
const statusEl = document.getElementById('admin-status');
const btnStart = document.getElementById('btn-start');
const btnStop = document.getElementById('btn-stop');
const chatWrapper = document.getElementById('chat-form-wrapper');
let adminActive = false;

// helper: show / hide chat and update body class so CSS height calc thay đổi
function showChat(){
    document.body.classList.add('chat-open');
    chatWrapper.setAttribute('aria-hidden','false');
    statusEl.textContent = "🟢 Đang tham gia";
    statusEl.classList.add('active');
    btnStart.style.display = 'none';
    btnStop.style.display = 'inline-block';
    setTimeout(()=>{ try{ messageInput.focus(); } catch(e){} }, 50);
}
function hideChat(){
    document.body.classList.remove('chat-open');
    chatWrapper.setAttribute('aria-hidden','true');
    statusEl.textContent = "🔴 Ngoại tuyến";
    statusEl.classList.remove('active');
    btnStart.style.display = 'inline-block';
    btnStop.style.display = 'none';
    try{ messageInput.blur(); } catch(e){}
}

// Khi bấm Bắt đầu tham gia
btnStart.addEventListener('click', async () => {
    adminActive = true;
    showChat();
    const message = "active";
    try{
        const res = await fetch(`/chat/bot/${conversationId}`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message })
        });
        await res.json();
    }catch(err){ console.error('❌ Lỗi fetch:', err); }
});

// Khi bấm Kết thúc
btnStop.addEventListener('click', async () => {
    adminActive = false;
    hideChat();
    const message = "inactive";
    try{
        const res = await fetch(`/chat/bot/${conversationId}`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message })
        });
        await res.json();
    }catch(err){ console.error('❌ Lỗi fetch:', err); }
});

// Gửi tin nhắn
form.addEventListener('submit', async (e) =>{
    e.preventDefault();
    //if (!adminActive) return;
    const message = messageInput.value.trim();
    if(!message) return;
    //resultDiv.insertAdjacentHTML('beforeend', `\n        <div class="form-group admin-message"><div class="inner"><strong>🧑 Admin:</strong> ${message}</div></div>\n    `);
    resultDiv.scrollTop = resultDiv.scrollHeight;
    messageInput.value = '';

    try{
        const res = await fetch(`/chat/${conversationId}`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message })
        });
        await res.json();
    }catch(err){ console.error('❌ Lỗi fetch:', err); }
});

const socket = window.socket;
socket.on('new_message', (data) =>{
    if (data.conversation_id != "{{ conversation.id }}") return;
    //if (data.sender != 'admin'){
        resultDiv.insertAdjacentHTML('beforeend', `\n <div class="form-group ${data.sender}-message">\n <div class="inner"><strong>🧑 ${data.sender}:</strong> ${data.message}</div>\n            </div>\n        `);
        resultDiv.scrollTop = resultDiv.scrollHeight;
    //}
    
});

// scroll to bottom on load
window.addEventListener('load', ()=>{ 
    const admin_active = "{{ admin_active }}";
    if (admin_active === "True" || admin_active === "true"){
        showChat();
    } else {
        hideChat();
    }
    resultDiv.scrollTop = resultDiv.scrollHeight; 
    });
</script>

{% endblock %}
