{% extends "base.html" %}
{% block content %}

<!-- Thanh tráº¡ng thÃ¡i admin: Ä‘áº·t phÃ­a trÃªn, ngoÃ i khung chat, luÃ´n cá»‘ Ä‘á»‹nh vÃ  khÃ´ng cáº§n scroll Ä‘á»ƒ nhÃ¬n tháº¥y -->
<div class="admin-status-bar" role="status" aria-live="polite">
    <div>Há»™i thoáº¡i: <strong>{{ conversation.id }}</strong></div>
    <div>Tráº¡ng thÃ¡i: <span id="admin-status" class="status-indicator">ðŸ”´ Ngoáº¡i tuyáº¿n</span></div>
    <div>
        <button id="btn-start" class="btn-toggle btn-start">Báº¯t Ä‘áº§u tham gia</button>
        <button id="btn-stop" class="btn-toggle btn-stop" style="display:none;">Káº¿t thÃºc</button>
    </div>
</div>
<!-- Danh sÃ¡ch tin nháº¯n -->
<div id="result">
    {% for msg in messages %}
        <div class="form-group {{ msg.message_type }}-message">
            <div class="inner">
                <b>{{ msg.message_type }}:</b> {{ msg.content }} <br>
                <small>{{ msg.sent_at }}</small>
            </div>
        </div>
    {% endfor %}
</div>

<!-- Khung chat (áº©n máº·c Ä‘á»‹nh) -->
<div class="chat-form" id="chat-form-wrapper" aria-hidden="{{ 'false' if admin_active else 'true' }}">
    <div id="chat-form-container">
        <form id="chat-form">
            <input type="text" id="message" name="message" placeholder="VÃ­ dá»¥: TÃ´i muá»‘n Ä‘áº·t thiá»‡p cÆ°á»›i..." required autocomplete="off" />
            <button type="submit">Gá»­i</button>
        </form>
    </div>
</div>

<script>
const conversationId = "{{ conversation.id }}";
const form = document.getElementById('chat-form');
const resultDiv = document.getElementById('result');
const messageInput = document.getElementById('message');
const statusEl = document.getElementById('admin-status');
const btnStart = document.getElementById('btn-start');
const btnStop = document.getElementById('btn-stop');
const chatWrapper = document.getElementById('chat-form-wrapper');
let adminActive = false;

// helper: show / hide chat and update body class so CSS height calc thay Ä‘á»•i
function showChat(){
    document.body.classList.add('chat-open');
    chatWrapper.setAttribute('aria-hidden','false');
    statusEl.textContent = "ðŸŸ¢ Äang tham gia";
    statusEl.classList.add('active');
    btnStart.style.display = 'none';
    btnStop.style.display = 'inline-block';
    setTimeout(()=>{ try{ messageInput.focus(); } catch(e){} }, 50);
}
function hideChat(){
    document.body.classList.remove('chat-open');
    chatWrapper.setAttribute('aria-hidden','true');
    statusEl.textContent = "ðŸ”´ Ngoáº¡i tuyáº¿n";
    statusEl.classList.remove('active');
    btnStart.style.display = 'inline-block';
    btnStop.style.display = 'none';
    try{ messageInput.blur(); } catch(e){}
}

// Khi báº¥m Báº¯t Ä‘áº§u tham gia
btnStart.addEventListener('click', async () => {
    adminActive = true;
    showChat();
    const message = "active";
    try{
        const res = await fetch(`/chat/bot/${conversationId}`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message })
        });
        await res.json();
    }catch(err){ console.error('âŒ Lá»—i fetch:', err); }
});

// Khi báº¥m Káº¿t thÃºc
btnStop.addEventListener('click', async () => {
    adminActive = false;
    hideChat();
    const message = "inactive";
    try{
        const res = await fetch(`/chat/bot/${conversationId}`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message })
        });
        await res.json();
    }catch(err){ console.error('âŒ Lá»—i fetch:', err); }
});

// Gá»­i tin nháº¯n
form.addEventListener('submit', async (e) =>{
    e.preventDefault();
    //if (!adminActive) return;
    const message = messageInput.value.trim();
    if(!message) return;
    //resultDiv.insertAdjacentHTML('beforeend', `\n        <div class="form-group admin-message"><div class="inner"><strong>ðŸ§‘ Admin:</strong> ${message}</div></div>\n    `);
    resultDiv.scrollTop = resultDiv.scrollHeight;
    messageInput.value = '';

    try{
        const res = await fetch(`/chat/${conversationId}`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message })
        });
        await res.json();
    }catch(err){ console.error('âŒ Lá»—i fetch:', err); }
});

const socket = window.socket;
socket.on('new_message', (data) =>{
    if (data.conversation_id != "{{ conversation.id }}") return;
    //if (data.sender != 'admin'){
        resultDiv.insertAdjacentHTML('beforeend', `\n <div class="form-group ${data.sender}-message">\n <div class="inner"><strong>ðŸ§‘ ${data.sender}:</strong> ${data.message}</div>\n            </div>\n        `);
        resultDiv.scrollTop = resultDiv.scrollHeight;
    //}
    
});

// scroll to bottom on load
window.addEventListener('load', ()=>{ 
    const admin_active = "{{ admin_active }}";
    if (admin_active === "True" || admin_active === "true"){
        showChat();
    } else {
        hideChat();
    }
    resultDiv.scrollTop = resultDiv.scrollHeight; 
    });
</script>

{% endblock %}
